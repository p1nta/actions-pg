name: Create Release

on:
  workflow_call:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating tags and releases
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0 # Fetch full history for tagging

      - name: Extract version and changelog
        id: extract
        run: |
          # Extract the latest version from CHANGELOG.md
          VERSION=$(grep -m 1 -oE '^## Version[[:space:]]+[0-9]+(\.[0-9]+)*' CHANGELOG.md | awk '{print $3}')
          if [ -z "$VERSION" ]; then
            echo "‚ùå No version found in CHANGELOG.md"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted version: $VERSION"

          # Extract changelog section for that version
          awk "/^## Version ${VERSION}/,/^## Version/" CHANGELOG.md | sed '$d' > /tmp/changelog_section.md || true
          if [ ! -s /tmp/changelog_section.md ]; then
            echo "‚ö†Ô∏è No specific changelog section found, using empty body"
            echo "" > /tmp/changelog_section.md
          fi
      - name: Check or create Git tag
        run: |
          TAG="v${{ steps.extract.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag $TAG already exists, skipping tag creation"
          else
            echo "üè∑Ô∏è Creating new tag $TAG"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.extract.outputs.version }}
          name: Version ${{ steps.extract.outputs.version }}
          body_path: /tmp/changelog_section.md
          draft: false
          # For a case where the version might be a pre-release (e.g., 1.0.0-beta)
          prerelease: ${{ contains(steps.extract.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
