name: Create Release

on:
  workflow_call:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating tags and releases
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0 # Fetch full history for tagging

      - name: Extract version and changelog
        id: extract
        run: |
          # Extract version from package.json
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ]; then
            echo "‚ùå No version found in package.json"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted version from package.json: $VERSION"

          # Check that the version exists in CHANGELOG.md
          if ! grep -q "^## Version[[:space:]]\+$VERSION" CHANGELOG.md; then
            echo "‚ùå Version $VERSION from package.json not found in CHANGELOG.md"
            echo "Please add a changelog entry for version $VERSION"
            exit 1
          fi
          echo "‚úÖ Changes for version $VERSION found in CHANGELOG.md"

          # Extract changelog section for that version
          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## Version/ {
              if ($3 == ver) {
                found=1
                next
              } else if (found) {
                exit
              }
            }
            found { print }
          ' CHANGELOG.md)

          if [ -z "$CHANGELOG" ]; then
            echo "‚ö†Ô∏è No specific changelog section found, using empty body"
            echo "" > /tmp/changelog_section.md
          else
            echo "$CHANGELOG" > /tmp/changelog_section.md
          fi
      - name: Check or create Git tag
        run: |
          TAG="v${{ steps.extract.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag $TAG already exists, skipping tag creation"
          else
            echo "üè∑Ô∏è Creating new tag $TAG"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.extract.outputs.version }}
          name: Version ${{ steps.extract.outputs.version }}
          body_path: /tmp/changelog_section.md
          draft: false
          # For a case where the version might be a pre-release (e.g., 1.0.0-beta)
          prerelease: ${{ contains(steps.extract.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
